# ==============================================================================
# CITRON WINDOWS BUILD WORKFLOW
# ==============================================================================
# This workflow builds Citron for Windows (x86_64 and ARM64) and publishes
# them as nightly releases.
#
# KEY FEATURES:
# - Centralized artifact naming: Citron-Nightly_<hash>-windows-<arch>.zip
# - Single continuously-updated release tag: nightly-windows
# - Parallel multi-architecture builds with fail-fast disabled
# - Automatic version detection and build skipping for unchanged commits
# - Platform-specific version tracking in ci/windows/LATEST_VERSION
# - Nightly releases marked as "latest" for easy access
# ==============================================================================

name: Build Citron - Windows

# Prevent concurrent builds from running simultaneously
concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

# Trigger on manual dispatch or daily schedule
on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # ============================================================
  # Centralized Version Checking and Artifact Naming
  # ============================================================
  check-version:
    name: Check if new version available
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      new_hash: ${{ steps.upstream.outputs.hash_short }}
      new_hash_full: ${{ steps.upstream.outputs.hash_full }}
      branch_name: ${{ steps.branch_check.outputs.branch_name }}
      build_type: ${{ steps.build_type.outputs.type }}
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.release_check.outputs.tag_name }}
      artifact_basename: ${{ steps.basename.outputs.artifact_basename }}

    steps:
      # Checkout this repository to access version tracking files
      - name: Checkout this repo
        uses: actions/checkout@v4

      # Detect which upstream branch to build from (feature branch or main)
      - name: Detect upstream branch and commit
        id: branch_check
        run: |
          REPO="https://git.citron-emu.org/Citron/Emulator.git"
          FEATURE="feature/android-game-file-extraction"
          if git ls-remote --heads "$REPO" "$FEATURE" | grep -q "$FEATURE"; then
            BRANCH="$FEATURE"
            HASH=$(git ls-remote "$REPO" "$FEATURE" | cut -f1)
            echo "Using feature branch"
          else
            BRANCH="main"
            HASH=$(git ls-remote "$REPO" HEAD | cut -f1)
            echo "Using main branch"
          fi
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "hash_full=$HASH" >> $GITHUB_OUTPUT
          echo "hash_short=${HASH:0:7}" >> $GITHUB_OUTPUT

      # Pass through the commit hash for use in downstream jobs
      - name: Get upstream commit hash
        id: upstream
        run: |
          echo "hash_short=${{ steps.branch_check.outputs.hash_short }}" >> $GITHUB_OUTPUT
          echo "hash_full=${{ steps.branch_check.outputs.hash_full }}" >> $GITHUB_OUTPUT

      # Clone upstream repo to get version information and source code
      - name: Clone upstream source
        id: version
        run: |
          git clone --depth 1 --branch "${{ steps.branch_check.outputs.branch_name }}" \
            https://git.citron-emu.org/Citron/Emulator.git temp_repo
          cd temp_repo
          
          # Try to get version from latest tag, fallback to commit date if no tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            # No tags found, use commit date as version
            VERSION=$(date +%Y.%m.%d)
            echo "No tags found, using date as version: $VERSION"
          else
            VERSION=${LATEST_TAG#v}
            echo "Found tag: $LATEST_TAG, version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Upload source code as artifact
      - name: Upload source code
        uses: actions/upload-artifact@v4
        with:
          name: source-code-${{ steps.upstream.outputs.hash_short }}
          path: temp_repo/
          retention-days: 1

      # Read the last built commit hash from the canonical version tracking file
      - name: Get last built version
        id: last_built
        run: |
          LAST_HASH=$(cat ci/nightly/LATEST_VERSION 2>/dev/null | tr -d '\n' || echo "none")
          # Parse format: <upstream-hash>:<workflow-hash> or just <hash> for legacy
          if [[ "$LAST_HASH" == *":"* ]]; then
            LAST_HASH=$(echo "$LAST_HASH" | cut -d: -f1)
          fi
          echo "last_hash=$LAST_HASH" >> $GITHUB_OUTPUT

      # This workflow only handles nightly builds
      - name: Set build type
        id: build_type
        run: |
          echo "type=nightly" >> $GITHUB_OUTPUT

      # Check if the nightly-windows release already exists
      - name: Check if release exists
        id: release_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="nightly-windows"
          
          if gh release view "$TAG_NAME" --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        continue-on-error: true

      # Generate the global artifact basename used by all Windows builds
      - name: Generate artifact basename
        id: basename
        run: |
          HASH="${{ steps.upstream.outputs.hash_short }}"
          BASENAME="Citron-Nightly_$HASH"
          
          echo "artifact_basename=$BASENAME" >> $GITHUB_OUTPUT
          echo "Generated basename: $BASENAME"

      # Determine if a build should be triggered
      - name: Compare versions
        id: compare
        run: |
          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Forced build requested"
          elif [ "${{ steps.upstream.outputs.hash_short }}" != "${{ steps.last_built.outputs.last_hash }}" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "New version detected"
          elif [ "${{ steps.release_check.outputs.exists }}" != "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "No release exists"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

  # ============================================================
  # Build Matrix - Windows Architectures
  # ============================================================
  build-matrix:
    name: Build Citron (${{ matrix.platform.name }})
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ${{ matrix.platform.runs_on }}
    timeout-minutes: ${{ matrix.platform.timeout }}

    strategy:
      fail-fast: false  # Continue building other architectures if one fails
      matrix:
        include:
          # Windows x86_64
          - platform:
              name: "Windows x86_64"
              runs_on: "windows-latest"
              arch: "x86_64"
              artifact_name: "windows-amd64"
              timeout: 360
              build_script: ci/windows/build.ps1
              build_args: ["-Arch", "x86_64", "-ArtifactBasename", "${{ needs.check-version.outputs.artifact_basename }}"]
              shell: pwsh
              artifact_path: "emulator/dist/*.zip"
              artifact_suffix: "-windows-amd64"

          # Windows ARM64
          - platform:
              name: "Windows ARM64"
              runs_on: "windows-11-arm"
              arch: "arm64"
              artifact_name: "windows-arm64"
              timeout: 360
              build_script: ci/windows/build.ps1
              build_args: ["-Arch", "arm64", "-ArtifactBasename", "${{ needs.check-version.outputs.artifact_basename }}"]
              shell: pwsh
              artifact_path: "emulator/dist/*.zip"
              artifact_suffix: "-windows-arm64"

    env:
      GIT_SHA: ${{ needs.check-version.outputs.new_hash }}
      GIT_SHA_FULL: ${{ needs.check-version.outputs.new_hash_full }}
      UPSTREAM_BRANCH: ${{ needs.check-version.outputs.branch_name }}

    steps:
      - name: Checkout workflow scripts
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Add msbuild to PATH
        if: matrix.platform.arch == 'x86_64'
        uses: microsoft/setup-msbuild@v2

      - name: Download source code
        uses: actions/download-artifact@v4
        with:
          name: source-code-${{ needs.check-version.outputs.new_hash }}
          path: emulator

      - name: Mark safe directory
        run: git config --global --add safe.directory "$PWD/emulator"

      - name: Initialize and update submodules
        working-directory: ./emulator
        shell: bash
        run: |
          git submodule init
          git submodule update --recursive

      - name: Cache vcpkg dependencies
        uses: actions/cache@v4
        id: cache-vcpkg
        with:
          path: emulator/build/vcpkg_installed
          key: vcpkg-windows-${{ matrix.platform.arch }}-${{ hashFiles('emulator/vcpkg.json') }}
          restore-keys: |
            vcpkg-windows-${{ matrix.platform.arch }}-
            vcpkg-windows-

      - name: Get Nightly Version
        id: version
        working-directory: ./emulator
        shell: bash
        run: |
          git fetch --tags
          VERSION=$(git rev-parse --short HEAD)
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Execute platform build
        run: |
          & ${{ matrix.platform.build_script }} ${{ join(matrix.platform.build_args, ' ') }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.check-version.outputs.artifact_basename }}${{ matrix.platform.artifact_suffix }}
          path: ${{ matrix.platform.artifact_path }}
          retention-days: 7
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.check-version.outputs.artifact_basename }}${{ matrix.platform.artifact_suffix }}-logs
          path: |
            emulator/build/**/*.log
            emulator/**/CMake*.txt
            emulator/**/CMake*.log
            emulator/**/*.log
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================
  # Create Unified Release
  # ============================================================
  create-release:
    name: Create Release
    needs: [check-version, build-matrix]
    if: |
      needs.check-version.outputs.should_build == 'true' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/new-build-process')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts
          pattern: "*"

      - name: Copy artifacts to release directory
        run: |
          mkdir -p ./release-files
          
          # Simply copy all artifacts from subdirectories
          find ./release-artifacts -type f -name "*.zip" -exec cp {} ./release-files/ \;
          
          echo "Artifacts found:"
          ls -lh ./release-files/

      - name: Generate Release Notes from Template
        id: generate_notes
        run: |
          chmod +x ci/generate-release-notes.sh
          
          # Get current date and time
          CURRENT_DATE=$(date +%Y-%m-%d)
          CURRENT_TIME=$(date +%H:%M:%S)
          
          # Generate release notes using the template
          RELEASE_BODY=$(bash ci/generate-release-notes.sh \
            "${{ needs.check-version.outputs.new_hash }}" \
            "${{ needs.check-version.outputs.new_hash_full }}" \
            "${{ needs.check-version.outputs.branch_name }}" \
            "${{ needs.check-version.outputs.version }}" \
            "$CURRENT_DATE" \
            "$CURRENT_TIME")
          
          # Save to file for use with gh-release
          echo "$RELEASE_BODY" > release-notes.md
          
          # Also output for debugging (first 1000 chars)
          echo "Generated release notes (first 1000 chars):"
          echo "$RELEASE_BODY" | head -c 1000
          echo "..."

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.tag_name }}
          name: Citron Windows Nightly (${{ needs.check-version.outputs.new_hash }})
          prerelease: true
          draft: false
          overwrite: true
          make_latest: true
          files: ./release-files/*
          body_path: release-notes.md

      - name: Update platform-specific version files
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update Windows version file (mirror of canonical)
          NEW_HASH="${{ needs.check-version.outputs.new_hash }}"
          echo "$NEW_HASH" > ci/windows/LATEST_VERSION
          
          # Add and commit version file
          git add ci/windows/LATEST_VERSION
          git commit -m "Update Windows version file to $NEW_HASH [skip ci]" || exit 0
          
          # Retry push with backoff
          for i in {1..5}; do
            if git pull --rebase && git push; then
              break
            fi
            sleep $((2**i))
          done

      - name: Post to Discord
        if: success()
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/tag/${{ needs.check-version.outputs.tag_name }}"
          DATE=$(date +'%Y-%m-%d')
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK }}"
          if [ -z "$WEBHOOK_URL" ]; then
            WEBHOOK_URL="https://discord.com/api/webhooks/1428304731809517588/fG7t7MBprKFss5oGcI05DIFM3JdO41Z0juSV_zOfb9K-UTvyI2fd3-Ciwi48npWXYHLb"
          fi
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"ðŸªŸ **New Windows Build Available!**\n\nðŸ“¦ **Version:** \`${{ needs.check-version.outputs.new_hash }}\`\nðŸ“… **Date:** ${DATE}\nðŸ”— **Download:** $DOWNLOAD_URL\n\nâœ¨ Includes x86_64 (AMD64) & ARM64 builds!\"}" \
               "$WEBHOOK_URL"
