name: Security Scanning

on:
  workflow_call:
    inputs:
      scan-type:
        description: 'Type of security scan (sast, dependencies, secrets, all)'
        required: true
        type: string
        default: 'all'
      fail-on-findings:
        description: 'Fail build if security issues are found'
        required: false
        type: boolean
        default: false
      severity-threshold:
        description: 'Minimum severity level to report (info, low, medium, high, critical)'
        required: false
        type: string
        default: 'medium'
    outputs:
      sast-status:
        value: ${{ jobs.security-scan.outputs.sast-status }}
      dependency-scan-status:
        value: ${{ jobs.security-scan.outputs.dependency-scan-status }}
      secrets-scan-status:
        value: ${{ jobs.security-scan.outputs.secrets-scan-status }}
      total-issues:
        value: ${{ jobs.security-scan.outputs.total-issues }}

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    outputs:
      sast-status: ${{ steps.sast.outputs.status }}
      dependency-scan-status: ${{ steps.dependencies.outputs.status }}
      secrets-scan-status: ${{ steps.secrets.outputs.status }}
      total-issues: ${{ steps.summary.outputs.total-issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup security tools
        run: |
          # Install security scanning tools
          sudo apt-get update
          sudo apt-get install -y \
            git-secrets \
            trufflehog \
            semgrep

      - name: SAST Scanning with CodeQL
        if: inputs.scan-type == 'all' || inputs.scan-type == 'sast'
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, go, java, csharp, ruby, python, javascript
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        if: inputs.scan-type == 'all' || inputs.scan-type == 'sast'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:all"

      - name: SAST Scanning with Semgrep
        if: inputs.scan-type == 'all' || inputs.scan-type == 'sast'
        id: sast
        run: |
          echo "Running SAST scan with Semgrep..."
          
          # Run Semgrep with OWASP rules
          semgrep scan \
            --config=auto \
            --config=p/security-audit \
            --config=p/secrets \
            --config=p/owasp-top-ten \
            --json \
            --output=sast-results.json \
            . || true
          
          # Parse results
          TOTAL_ISSUES=$(jq '.results | length' sast-results.json 2>/dev/null || echo "0")
          CRITICAL_ISSUES=$(jq '[.results[] | select(.severity == "ERROR")] | length' sast-results.json 2>/dev/null || echo "0")
          HIGH_ISSUES=$(jq '[.results[] | select(.severity == "WARNING")] | length' sast-results.json 2>/dev/null || echo "0")
          
          echo "total_issues=$TOTAL_ISSUES" >> "$GITHUB_OUTPUT"
          echo "critical_issues=$CRITICAL_ISSUES" >> "$GITHUB_OUTPUT"
          echo "high_issues=$HIGH_ISSUES" >> "$GITHUB_OUTPUT"
          
          if [ "$TOTAL_ISSUES" -gt "0" ]; then
            echo "status=issues_found" >> "$GITHUB_OUTPUT"
            echo "❌ SAST scan found $TOTAL_ISSUES issues ($CRITICAL_ISSUES critical, $HIGH_ISSUES high)"
          else
            echo "status=clean" >> "$GITHUB_OUTPUT"
            echo "✅ SAST scan completed with no issues"
          fi
          
          # Upload SAST results
          if [ -f sast-results.json ]; then
            echo "SAST results available in sast-results.json"
          fi

      - name: Dependency Vulnerability Scanning
        if: inputs.scan-type == 'all' || inputs.scan-type == 'dependencies'
        id: dependencies
        run: |
          echo "Running dependency vulnerability scan..."
          
          # Check for different dependency files
          DEPENDENCY_ISSUES=0
          
          # Python dependencies
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "Found Python dependencies, scanning..."
            pip install safety bandit
            safety check --json --output safety-results.json || true
            bandit -r . -f json -o bandit-results.json || true
            DEPENDENCY_ISSUES=$((DEPENDENCY_ISSUES + $(jq '.vulnerabilities | length' safety-results.json 2>/dev/null || echo "0")))
          fi
          
          # Node.js dependencies
          if [ -f "package.json" ]; then
            echo "Found Node.js dependencies, scanning..."
            npm audit --json > npm-audit-results.json || true
            DEPENDENCY_ISSUES=$((DEPENDENCY_ISSUES + $(jq '.metadata.vulnerabilities.total // 0' npm-audit-results.json 2>/dev/null || echo "0")))
          fi
          
          # Rust dependencies
          if [ -f "Cargo.toml" ]; then
            echo "Found Rust dependencies, scanning..."
            cargo install cargo-audit
            cargo audit --json > cargo-audit-results.json || true
            DEPENDENCY_ISSUES=$((DEPENDENCY_ISSUES + $(jq '.vulnerabilities.total // 0' cargo-audit-results.json 2>/dev/null || echo "0")))
          fi
          
          # Java dependencies
          if [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            echo "Found Java dependencies, scanning..."
            # Use OWASP Dependency Check
            wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
            unzip -q dependency-check-8.4.0-release.zip
            ./dependency-check/bin/dependency-check.sh --project Citron --scan . --format JSON --out dependency-check-results.json || true
            DEPENDENCY_ISSUES=$((DEPENDENCY_ISSUES + $(jq '.dependencies[]?.vulnerabilities | length // 0' dependency-check-results.json 2>/dev/null | awk '{sum+=$1} END {print sum}' || echo "0")))
          fi
          
          echo "dependency_issues=$DEPENDENCY_ISSUES" >> "$GITHUB_OUTPUT"
          
          if [ "$DEPENDENCY_ISSUES" -gt "0" ]; then
            echo "status=issues_found" >> "$GITHUB_OUTPUT"
            echo "❌ Dependency scan found $DEPENDENCY_ISSUES vulnerabilities"
          else
            echo "status=clean" >> "$GITHUB_OUTPUT"
            echo "✅ Dependency scan completed with no vulnerabilities"
          fi

      - name: Secrets Detection
        if: inputs.scan-type == 'all' || inputs.scan-type == 'secrets'
        id: secrets
        run: |
          echo "Running secrets detection scan..."
          
          SECRETS_FOUND=0
          
          # Git Secrets scan
          git secrets --install
          git secrets --register-aws
          git secrets --scan > git-secrets-results.txt || true
          if [ -s git-secrets-results.txt ]; then
            SECRETS_FOUND=$((SECRETS_FOUND + $(wc -l < git-secrets-results.txt)))
          fi
          
          # TruffleHog scan
          wget -q https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog_unix_amd64.tar.gz
          tar -xzf trufflehog_unix_amd64.tar.gz
          ./trufflehog git file://. --json > trufflehog-results.json || true
          SECRETS_FOUND=$((SECRETS_FOUND + $(jq 'length' trufflehog-results.json 2>/dev/null || echo "0")))
          
          echo "secrets_found=$SECRETS_FOUND" >> "$GITHUB_OUTPUT"
          
          if [ "$SECRETS_FOUND" -gt "0" ]; then
            echo "status=issues_found" >> "$GITHUB_OUTPUT"
            echo "❌ Secrets scan found $SECRETS_FOUND potential secrets"
          else
            echo "status=clean" >> "$GITHUB_OUTPUT"
            echo "✅ Secrets scan completed with no issues"
          fi

      - name: Container Security Scanning
        if: contains(github.event_name, 'pull_request') || github.event_name == 'push'
        run: |
          echo "Checking for Dockerfiles and scanning containers..."
          
          # Check for Dockerfile
          if [ -f "Dockerfile" ]; then
            echo "Found Dockerfile, scanning for vulnerabilities..."
            
            # Build image for scanning
            docker build -t citron-scan:latest . || true
            
            # Use Trivy for container scanning
            if command -v trivy &> /dev/null; then
              trivy image --format json --output container-scan-results.json citron-scan:latest || true
            fi
          fi

      - name: License Compliance Check
        run: |
          echo "Checking license compliance..."
          
          # Check for license files
          LICENSE_ISSUES=0
          
          if [ ! -f "LICENSE" ] && [ ! -f "LICENSE.txt" ] && [ ! -f "LICENSE.md" ]; then
            echo "⚠️ No LICENSE file found in repository root"
            LICENSE_ISSUES=$((LICENSE_ISSUES + 1))
          fi
          
          # Check dependencies licenses (basic check)
          if [ -f "package.json" ]; then
            echo "Checking Node.js dependencies licenses..."
            # This is a basic check - in production, use proper license scanning tools
          fi
          
          echo "license_issues=$LICENSE_ISSUES" >> "$GITHUB_OUTPUT"

      - name: Security Summary
        id: summary
        run: |
          # Aggregate all security scan results
          TOTAL_ISSUES=0
          
          if [ -n "${{ steps.sast.outputs.total_issues }}" ]; then
            TOTAL_ISSUES=$((TOTAL_ISSUES + ${{ steps.sast.outputs.total_issues }}))
          fi
          
          if [ -n "${{ steps.dependencies.outputs.dependency_issues }}" ]; then
            TOTAL_ISSUES=$((TOTAL_ISSUES + ${{ steps.dependencies.outputs.dependency_issues }}))
          fi
          
          if [ -n "${{ steps.secrets.outputs.secrets_found }}" ]; then
            TOTAL_ISSUES=$((TOTAL_ISSUES + ${{ steps.secrets.outputs.secrets_found }}))
          fi
          
          echo "total-issues=$TOTAL_ISSUES" >> "$GITHUB_OUTPUT"
          
          # Create security report
          cat > security-report.md << EOF
          # Security Scan Report
          
          **Scan Date:** $(date)
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}
          **Workflow:** ${{ github.workflow }}
          
          ## Summary
          - **Total Issues Found:** $TOTAL_ISSUES
          - **SAST Status:** ${{ steps.sast.outputs.status || 'not_run' }}
          - **Dependencies Status:** ${{ steps.dependencies.outputs.status || 'not_run' }}
          - **Secrets Status:** ${{ steps.secrets.outputs.status || 'not_run' }}
          
          ## Detailed Results
          - SAST Issues: ${{ steps.sast.outputs.total_issues || '0' }}
          - Dependency Vulnerabilities: ${{ steps.dependencies.outputs.dependency_issues || '0' }}
          - Secrets Found: ${{ steps.secrets.outputs.secrets_found || '0' }}
          
          ## Recommendations
          1. Review and fix all critical and high severity issues
          2. Implement security best practices in development workflow
          3. Regular dependency updates and security monitoring
          4. Use secrets management tools for sensitive information
          EOF
          
          echo "Security scan completed with $TOTAL_ISSUES total issues"

      - name: Upload Security Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            sast-results.json
            safety-results.json
            bandit-results.json
            npm-audit-results.json
            cargo-audit-results.json
            dependency-check-results.json
            git-secrets-results.txt
            trufflehog-results.json
            container-scan-results.json
            security-report.md
          retention-days: 30

      - name: Fail on Security Issues
        if: inputs.fail-on-findings == true && steps.summary.outputs.total-issues != '0'
        run: |
          echo "❌ Security scan failed due to findings"
          echo "Total issues: ${{ steps.summary.outputs.total-issues }}"
          exit 1

      - name: Create Security Issue
        if: inputs.fail-on-findings == true && steps.summary.outputs.total-issues != '0'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security Issues Found in CI/CD Pipeline',
              body: `
                **Security Scan Results**
                
                - **Total Issues:** ${{ steps.summary.outputs.total-issues }}
                - **Scan Date:** ${new Date().toISOString()}
                - **Commit:** ${context.sha}
                - **Workflow:** ${context.workflow}
                
                Please review the security scan results and address all critical issues.
                
                **Next Steps:**
                1. Review the uploaded security scan artifacts
                2. Fix all critical and high severity issues
                3. Re-run the security scan
                4. Consider implementing additional security measures
              `,
              labels: ['security', 'ci-cd', 'high-priority']
            })