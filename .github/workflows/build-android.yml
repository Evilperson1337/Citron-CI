name: Build Citron (Android)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"

permissions:
  contents: read

jobs:
  check-version:
    name: Check if new version available
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.compare.outputs.should_build }}
      new_hash: ${{ steps.upstream.outputs.hash_short }}
      new_hash_full: ${{ steps.upstream.outputs.hash_full }}
      branch_name: ${{ steps.branch_check.outputs.branch_name }}
      new_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Check if feature branch exists and get commit hash
        id: branch_check
        run: |
          REPO_URL="https://git.citron-emu.org/Citron/Emulator.git"
          FEATURE="NULL"

          if git ls-remote --heads "$REPO_URL" "$FEATURE" | grep -q "$FEATURE"; then
            BRANCH_NAME="$FEATURE"
            FULL_HASH=$(git ls-remote "$REPO_URL" "$FEATURE" | cut -f1)
            echo "‚úÖ Using feature branch: $BRANCH_NAME"
          else
            BRANCH_NAME="main"
            FULL_HASH=$(git ls-remote "$REPO_URL" HEAD | cut -f1)
            echo "‚ö†Ô∏è Feature branch not found, falling back to: $BRANCH_NAME"
          fi

          SHORT_HASH=$(echo "$FULL_HASH" | cut -c1-8)
          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "hash_short=$SHORT_HASH" >> "$GITHUB_OUTPUT"
          echo "hash_full=$FULL_HASH" >> "$GITHUB_OUTPUT"
          echo "hash(short): $SHORT_HASH"
          echo "hash(full):   $FULL_HASH"

      - name: Get upstream commit hash
        id: upstream
        run: |
          echo "hash_short=${{ steps.branch_check.outputs.hash_short }}" >> "$GITHUB_OUTPUT"
          echo "hash_full=${{ steps.branch_check.outputs.hash_full }}" >> "$GITHUB_OUTPUT"
          echo "Upstream short: ${{ steps.branch_check.outputs.hash_short }}"

      - name: Get latest version
        id: version
        run: |
          git clone --depth 1 --branch ${{ steps.branch_check.outputs.branch_name }} https://git.citron-emu.org/Citron/Emulator.git temp_repo
          cd temp_repo
          LATEST_TAG=$(git describe --tags --abbrev=0)
          VERSION=${LATEST_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get last built version
        id: last_built
        run: |
          LAST_HASH=$(cat LATEST_VERSION 2>/dev/null | tr -d '\n' || echo "none")
          echo "last_hash=$LAST_HASH" >> "$GITHUB_OUTPUT"
          echo "Last built hash: $LAST_HASH"

      - name: Check if release exists
        id: release_check
        run: |
          if gh release view nightly-android --repo "${{ github.repository }}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release does not exist"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Compare versions
        id: compare
        run: |
          if [ "${{ steps.upstream.outputs.hash_short }}" != "${{ steps.last_built.outputs.last_hash }}" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ New version detected - will build"
          elif [ "${{ steps.release_check.outputs.exists }}" != "true" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ No release exists - will build"
          else
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è No changes - skipping build"
          fi

  build-android:
    name: Build Android APK
    needs: [check-version]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    outputs:
      git_hash: ${{ steps.get_hash.outputs.git_hash }}
      branch_name: ${{ needs.check-version.outputs.branch_name }}

    steps:
      - name: Clone Citron Source Code
        shell: bash
        run: |
          REPO_URL="https://git.citron-emu.org/Citron/Emulator.git"
          FEATURE="feature/android-game-file-extraction"
          BRANCH_ARG="" # Initialize empty branch argument

          if [ "${{ needs.check-version.outputs.branch_name }}" = "$FEATURE" ]; then
            echo "üåø Preparing to clone feature branch: $FEATURE"
            BRANCH_ARG="-b $FEATURE"
          else
            echo "üì¶ Preparing to clone main branch"
          fi

          for i in {1..5}; do
            echo "Attempting to clone repository (Attempt $i of 5)..."
            
            if git clone --recursive --depth 1 $BRANCH_ARG "$REPO_URL" citron_source; then
              echo "‚úÖ Clone successful."
              break # Exit the loop on success
            fi
            
            if [ "$i" -eq 5 ]; then
              echo "‚ùå Failed to clone repository after 5 attempts."
              exit 1
            fi

            echo "‚ö†Ô∏è Clone failed. Retrying in 15 seconds..."
            sleep 15
          done

      - name: Clean and Force-Update Submodules
        working-directory: ./citron_source
        run: |
          git submodule deinit --all --force
          git submodule update --init --recursive --force

      - name: Get Citron Commit Hash
        id: get_hash
        working-directory: ./citron_source
        run: echo "git_hash=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            wget unzip curl git cmake build-essential \
            pkg-config zip glslang-tools nasm perl \
            autoconf automake libtool yasm

      - name: Install Android SDK Command-line Tools
        run: |
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p android-sdk/cmdline-tools
          mv cmdline-tools android-sdk/cmdline-tools/latest

      - name: Set up Android Environment Variables
        run: |
          echo "ANDROID_HOME=$PWD/android-sdk" >> "$GITHUB_ENV"
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses and install NDK
        run: |
          yes | sdkmanager --licenses > /dev/null || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Configure CMake for Android
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          cmake -B build-android -S citron_source \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-30 \
            -DANDROID_ARM_NEON=ON \
            -DENABLE_QT=OFF \
            -DENABLE_SDL2=OFF \
            -DENABLE_WEB_SERVICE=OFF \
            -DENABLE_OPENSSL=OFF \
            -DCITRON_USE_BUNDLED_VCPKG=ON \
            -DCITRON_USE_BUNDLED_FFMPEG=ON \
            -DCITRON_ENABLE_LTO=ON

      - name: Build with CMake
        run: |
          cmake --build build-android --config Release --parallel "$(nproc)"

      - name: Build APK with Gradle
        working-directory: ./citron_source/src/android
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
        run: |
          export ANDROID_SDK_ROOT="$ANDROID_HOME"
          chmod +x gradlew
          ./gradlew assembleMainlineRelease -Pcmake.args="-DENABLE_WEB_SERVICE=OFF -DENABLE_OPENSSL=OFF"

      - name: Rename APK
        working-directory: ./citron_source/src/android
        run: |
          APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::Build failed: No APK file was found."
            exit 1
          fi
          mkdir -p artifacts
          APK_NAME="Citron-v${{ needs.check-version.outputs.new_version }}-nightly.${{ needs.check-version.outputs.new_hash }}-android-arm64-release.apk"
          mv "$APK_PATH" "artifacts/$APK_NAME.apk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: citron-android-nightly
          path: citron_source/src/android/artifacts/*.apk

  build-android-8elite:
    name: Build Android APK (Snapdragon 8 Elite)
    needs: [check-version]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    outputs:
      git_hash: ${{ steps.get_hash.outputs.git_hash }}
      branch_name: ${{ needs.check-version.outputs.branch_name }}

    env:
      TARGET: Lyb
      MODEL: "8 Elite"
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPILERCHECK: content
      CCACHE_SLOPPINESS: time_macros

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ccache glslang-tools libvulkan-dev python3-requests patch

      - name: Clone Citron Source Code
        run: |
          REPO_URL="https://git.citron-emu.org/Citron/Emulator.git"
          FEATURE="feature/android-game-file-extraction"
          
          if [ "${{ needs.check-version.outputs.branch_name }}" = "$FEATURE" ]; then
            echo "üåø Cloning feature branch: ${{ needs.check-version.outputs.branch_name }}"
            git clone --recurse-submodules --depth 1 -b "$FEATURE" "$REPO_URL" citron_source
          else
            echo "üì¶ Cloning main branch"
            git clone --recurse-submodules --depth 1 "$REPO_URL" citron_source
          fi

      - name: Clean and Force-Update Submodules
        working-directory: ./citron_source
        run: |
          git submodule deinit --all --force
          git submodule update --init --recursive --force

      - name: Get Citron Commit Hash
        id: get_hash
        working-directory: ./citron_source
        run: echo "git_hash=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Apply All Patches (Snapdragon 8 Elite)
        working-directory: ./citron_source
        run: |
          echo "Applying Snapdragon 8 Elite patches..."

          # --- Patch 1: Force System Driver Load (native.cpp) ---
          sed -i '/if (!handle) {/,/}/c\    if (!handle) {\n        handle = dlopen("libvulkan.so", RTLD_NOW);\n    }' src/android/app/src/main/jni/native.cpp

          # --- Patch 2: 8 Elite Fixes for Qualcomm (vulkan_device.h) ---
          sed -i '/bool IsShaderInt64Supported() const {/a \        const auto driver = GetDriverID();\n        if (driver == VK_DRIVER_ID_QUALCOMM_PROPRIETARY) {\n            return false;\n        }' src/video_core/vulkan_common/vulkan_device.h
          sed -i '/bool IsExtShaderAtomicInt64Supported() const {/a \        const auto driver = GetDriverID();\n        if (driver == VK_DRIVER_ID_QUALCOMM_PROPRIETARY) {\n            return false;\n        }' src/video_core/vulkan_common/vulkan_device.h

          # --- Patch 3: 8 Elite & Cleanup Fixes (vulkan_device.cpp) ---
          # 3a: Delete the original `device_id` variable declaration.
          sed -i '/const auto device_id =/d' src/video_core/vulkan_common/vulkan_device.cpp
          
          # 3b: Replace all usages of the now-deleted `device_id` with its full source path to prevent compile errors.
          sed -i 's/\bdevice_id\b/properties.properties.deviceID/g' src/video_core/vulkan_common/vulkan_device.cpp

          # 3c: This is the corrected logic: Instead of adding a new variable, we use the `driver_id`
          # variable that already exists in the correct C++ scope. This fixes the compile error.
          sed -i 's/if (is_qualcomm) {/if (driver_id == VK_DRIVER_ID_QUALCOMM_PROPRIETARY) {/' src/video_core/vulkan_common/vulkan_device.cpp
          
          echo "All patches applied successfully."

      - name: Setup and Restore Cache
        uses: actions/cache@v4
        id: ccache-cache
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-android-ccache-${{ env.TARGET }}-${{ github.ref_name }}-${{ hashFiles('citron_source/**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-android-ccache-${{ env.TARGET }}-${{ github.ref_name }}-
            ${{ runner.os }}-android-ccache-${{ env.TARGET }}-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            wget unzip curl git cmake build-essential \
            pkg-config zip glslang-tools nasm perl \
            autoconf automake libtool yasm

      - name: Install Android SDK Command-line Tools
        run: |
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mkdir -p android-sdk/cmdline-tools
          mv cmdline-tools android-sdk/cmdline-tools/latest

      - name: Set up Android Environment Variables
        run: |
          echo "ANDROID_HOME=$PWD/android-sdk" >> "$GITHUB_ENV"
          echo "$PWD/android-sdk/cmdline-tools/latest/bin" >> "$GITHUB_PATH"

      - name: Accept Android SDK licenses and install NDK
        run: |
          yes | sdkmanager --licenses > /dev/null || true
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Configure CMake for Android
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          cmake -B build-android -S citron_source \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-30 \
            -DANDROID_ARM_NEON=ON \
            -DENABLE_QT=OFF \
            -DENABLE_SDL2=OFF \
            -DENABLE_WEB_SERVICE=OFF \
            -DENABLE_OPENSSL=OFF \
            -DCITRON_USE_BUNDLED_VCPKG=ON \
            -DCITRON_USE_BUNDLED_FFMPEG=ON \
            -DCITRON_ENABLE_LTO=ON

      - name: Build with CMake
        run: |
          cmake --build build-android --config Release --parallel "$(nproc)"

      - name: Compile Android APK (Snapdragon 8 Elite)
        working-directory: ./citron_source/src/android
        run: |
          # The git command needs to run from the cloned git repo to get the correct commit count
          COUNT="$(git -C ../.. rev-list --count HEAD)"
          APK_NAME="Citron-v${{ needs.check-version.outputs.new_version }}-nightly.${{ needs.check-version.outputs.new_hash }}-android-arm64-snapdragon.apk"
          
          export ANDROID_SDK_ROOT="$ANDROID_HOME"
          chmod +x ./gradlew
          BUILD_ARGS=(-PCITRON_ANDROID_ARGS "-DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DENABLE_UPDATE_CHECKER=ON")
          ./gradlew assembleMainlineRelease "${BUILD_ARGS[@]}"
          
          APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::Build failed: No APK file was found."
            exit 1
          fi
          
          mkdir -p artifacts
          mv "$APK_PATH" "artifacts/$APK_NAME.apk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: citron-android-8elite
          path: citron_source/src/android/artifacts/*.apk

  release-android:
    name: "Release Android Nightly"
    needs: [check-version, build-android, build-android-8elite]
    if: needs.check-version.outputs.should_build == 'true'
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: citron-android-*
          merge-multiple: true
          path: .

      - name: Get version info for release name
        shell: bash
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> "$GITHUB_ENV"
          echo "GIT_HASH=${{ needs.build-android.outputs.git_hash }}" >> "$GITHUB_ENV"
          echo "BRANCH_NAME=${{ needs.check-version.outputs.branch_name }}" >> "$GITHUB_ENV"

      - name: Delete previous nightly release and tag
        run: gh release delete "nightly-android" --repo "${{ github.repository }}" --cleanup-tag -y || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new nightly release
        uses: softprops/action-gh-release@v2
        with:
          name: "Continuous Build: (Android Nightly: ${{ env.GIT_HASH }})"
          tag_name: "nightly-android"
          prerelease: true
          files: "*.apk"
          body: |
            **Citron Upstream Commit:** [`${{ needs.check-version.outputs.new_hash }}`](https://git.citron-emu.org/Citron/Emulator/commit/${{ needs.check-version.outputs.new_hash_full }})

            This build is based on the latest Citron emulator source code from the **${{ env.BRANCH_NAME }}** branch.

            **Build Details:**
            - Platform: Android (arm64-v8a)
            - Build Type: Release with LTO enabled
            - Date: ${{ env.DATE }}
            - Branch: ${{ env.BRANCH_NAME }}
            - Includes: Standard build + Snapdragon 8 Elite build with Qualcomm patches

      - name: Update LATEST_VERSION
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "${{ needs.check-version.outputs.new_hash }}" > LATEST_VERSION
          git add LATEST_VERSION
          git commit -m "Update LATEST_VERSION to ${{ needs.check-version.outputs.new_hash }} [skip ci]" || exit 0
          for i in {1..5}; do
            git pull --rebase origin main && git push && break || sleep 2
          done

      - name: Post to Discord
        if: success()
        run: |
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/tag/nightly-android"
          if [ "${{ env.BRANCH_NAME }}" = "feature/android-game-file-extraction" ]; then
            BRANCH_EMOJI="üçã"
            BRANCH_DESC="Game File Extraction"
            EXPERIMENTAL_FEATURES="\nüî¨ **New Features:**\n‚Ä¢ RomFS dumping support\n‚Ä¢ ExeFS dumping support\n‚Ä¢ Custom dump location selection"
          else
            BRANCH_EMOJI="üì¶"
            BRANCH_DESC="Main Branch"
            EXPERIMENTAL_FEATURES=""
          fi
          WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "::error::DISCORD_WEBHOOK secret is required but not set"
            exit 1
          fi
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"ü§ñ **New Android Build Available!**\n\nüì¶ **Version:** \`${{ env.GIT_HASH }}\`\nüìÖ **Date:** ${{ env.DATE }}\n$BRANCH_EMOJI **Branch:** $BRANCH_DESC$EXPERIMENTAL_FEATURES\nüîó **Download:** $DOWNLOAD_URL\"}" \
               "$WEBHOOK_URL"
