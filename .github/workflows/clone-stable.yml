name: Clone Official Releases

# Prevent concurrent builds from interfering with each other
concurrency:
  group: mirror-forgejo-releases
  cancel-in-progress: false

on:
  schedule:
    - cron: "0 */12 * * *" # every 12 hours
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Optional: Specific Forgejo tag to mirror (e.g., "1.2.3" or "v1.2.3"). Leave empty to use latest release.'
        required: false
        type: string
      release_tag_override:
        description: 'Optional: Custom GitHub release tag name (e.g., "v1.2.3-custom"). Leave empty to use the Forgejo tag name.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Cache apt packages for faster dependency installation
      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-cache-${{ runner.os }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # Validate input parameters
      - name: Validate inputs
        run: |
          echo "Validating input parameters..."
          
          # Validate tag_name if provided
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            if [[ ! "${{ github.event.inputs.tag_name }}" =~ ^(v)?[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              echo "‚ùå Error: Invalid tag format. Expected format: v1.2.3 or 1.2.3 or v1.2.3-rc1"
              echo "Received: ${{ github.event.inputs.tag_name }}"
              exit 1
            fi
            echo "‚úì Valid tag format: ${{ github.event.inputs.tag_name }}"
          fi
          
          # Validate release_tag_override if provided (must have v prefix)
          if [ -n "${{ github.event.inputs.release_tag_override }}" ]; then
            if [[ ! "${{ github.event.inputs.release_tag_override }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              echo "‚ùå Error: Invalid release tag format. Expected format: v1.2.3-custom (must start with 'v')"
              echo "Received: ${{ github.event.inputs.release_tag_override }}"
              exit 1
            fi
            echo "‚úì Valid release tag format: ${{ github.event.inputs.release_tag_override }}"
          fi
          
          echo "‚úì All input validations passed"

      # Helper function for retry logic
      - name: Setup retry function
        id: retry_setup
        run: |
          cat >> retry.sh << 'EOF'
          # Retry function for network operations
          retry_command() {
            local cmd="$1"
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..." >&2
              if eval "$cmd"; then
                echo "‚úì Command succeeded on attempt $attempt" >&2
                return 0
              else
                echo "‚úó Command failed on attempt $attempt" >&2
                if [ $attempt -lt $max_attempts ]; then
                  echo "Retrying in 5 seconds..." >&2
                  sleep 5
                fi
                attempt=$((attempt + 1))
              fi
            done
            
            echo "‚ùå Command failed after $max_attempts attempts" >&2
            return 1
          }
          EOF
          chmod +x retry.sh

      - name: Fetch Forgejo release
        id: forgejo
        run: |
          # Source the retry function
          source ./retry.sh
          
          # Use provided tag or fetch latest
          if [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "Using provided tag: ${{ github.event.inputs.tag_name }}"
            API_URL="https://git.citron-emu.org/api/v1/repos/Citron/Emulator/releases/tags/${{ github.event.inputs.tag_name }}"
          else
            echo "Fetching latest release"
            API_URL="https://git.citron-emu.org/api/v1/repos/Citron/Emulator/releases/latest"
          fi
          
          echo "API URL: $API_URL"

          # Fetch release with retry and error handling
          release_json=$(retry_command "curl -fsSL '$API_URL'" || echo "ERROR")
          if [ "$release_json" = "ERROR" ] || [ -z "$release_json" ]; then
            echo "‚ùå Failed to fetch release from Forgejo API after 3 attempts"
            echo "API URL: $API_URL"
            exit 1
          fi

          echo "$release_json" > forgejo_release.json
          
          # Validate JSON response
          if ! jq empty forgejo_release.json 2>/dev/null; then
            echo "‚ùå Invalid JSON response from Forgejo API"
            echo "Response: $(cat forgejo_release.json | head -c 200)"
            exit 1
          fi

          tag=$(jq -r '.tag_name' forgejo_release.json)
          name=$(jq -r '.name' forgejo_release.json)
          
          # Validate required fields
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "‚ùå Failed to extract tag_name from response"
            exit 1
          fi
          if [ -z "$name" ] || [ "$name" = "null" ]; then
            echo "‚ùå Failed to extract name from response"
            exit 1
          fi

          # Use custom release tag if provided, otherwise normalize the Forgejo tag
          if [ -n "${{ github.event.inputs.release_tag_override }}" ]; then
            release_tag="${{ github.event.inputs.release_tag_override }}"
          else
            # Normalize tag to always have 'v' prefix (e.g., "0.12.25" -> "v0.12.25")
            if [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              # Tag already has v prefix, use as-is
              release_tag="$tag"
            elif [[ "$tag" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
              # Tag is missing v prefix, add it
              release_tag="v$tag"
              echo "Normalized tag: $tag -> $release_tag"
            else
              # Tag has unexpected format, use as-is but warn
              release_tag="$tag"
              echo "‚ö†Ô∏è  Warning: Tag has unexpected format: $tag"
            fi
          fi

          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          echo "‚úì Successfully fetched release information"
          echo "  Tag: $tag"
          echo "  Name: $name"
          echo "  Release Tag: $release_tag"

      - name: Check if release already exists on GitHub
        id: check
        run: |
          # Check if GitHub release exists
          if gh release view "${{ steps.forgejo.outputs.release_tag }}" >/dev/null 2>&1; then
            echo "Release exists on GitHub"
            echo "exists=true" >> $GITHUB_OUTPUT
            
            # Get GitHub release assets
            gh release view "${{ steps.forgejo.outputs.release_tag }}" --json assets --jq '.assets[].name' > github_assets.txt 2>/dev/null || echo "" > github_assets.txt
            
            # Get Forgejo release assets from the JSON we already fetched
            jq -r '.assets[].name' forgejo_release.json > forgejo_assets.txt
            
            # Sort and compare
            sort github_assets.txt > github_assets_sorted.txt
            sort forgejo_assets.txt > forgejo_assets_sorted.txt
            
            if diff -q github_assets_sorted.txt forgejo_assets_sorted.txt >/dev/null 2>&1; then
              echo "All assets match - no update needed"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            else
              echo "Assets differ - update needed"
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "GitHub assets:"
              cat github_assets.txt || echo "(none)"
              echo "Forgejo assets:"
              cat forgejo_assets.txt
            fi
          else
            echo "Release does not exist on GitHub"
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stop if no new releases
        if: steps.check.outputs.needs_update == 'false'
        run: |
          echo "Release already exists with matching assets. Exiting."

      - name: Download and rename assets
        if: steps.check.outputs.needs_update == 'true'
        run: |
          mkdir -p assets
          source ./retry.sh
          
          echo "Downloading assets from Forgejo release..."
          asset_count=$(jq -r '.assets | length' forgejo_release.json)
          echo "Found $asset_count assets to download"
          
          jq -r '.assets[] | "\(.browser_download_url) \(.name)"' forgejo_release.json \
          | while read url name; do
              echo "üì• Downloading: $name"
              echo "   URL: $url"
              
              # Download with retry logic
              if ! retry_command "curl -L '$url' -o 'assets/$name'"; then
                echo "‚ùå Failed to download $name after 3 attempts"
                exit 1
              fi
              
              echo "‚úì Downloaded: $name"
          done
          
          echo "‚úì All assets downloaded successfully"

      - name: Verify downloaded assets
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "Verifying downloaded assets..."
          
          # Check if assets directory exists and has files
          if [ ! -d "assets" ]; then
            echo "‚ùå Assets directory not found"
            exit 1
          fi
          
          asset_count=$(ls -1 assets/ | wc -l)
          if [ "$asset_count" -eq 0 ]; then
            echo "‚ùå No assets found in assets directory"
            exit 1
          fi
          
          echo "Found $asset_count assets:"
          
          # Verify each asset
          for file in assets/*; do
            if [ ! -s "$file" ]; then
              echo "‚ùå Error: $file is empty or doesn't exist"
              exit 1
            fi
            
            file_size=$(stat -c%s "$file")
            echo "‚úì $(basename "$file"): $file_size bytes"
          done
          
          echo "‚úì All assets verified successfully"

      - name: Create or update GitHub release
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Check if release already exists
          if gh release view "${{ steps.forgejo.outputs.release_tag }}" >/dev/null 2>&1; then
            echo "Release already exists, uploading new assets..."
          else
            echo "Creating new draft release..."
            gh release create "${{ steps.forgejo.outputs.release_tag }}" \
              --title "${{ steps.forgejo.outputs.name }}" \
              --draft \
              --notes "Mirrored from Forgejo release. [skip ci]"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Generate workflow summary
      - name: Workflow Summary
        if: always()
        run: |
          echo "## Mirror Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Forgejo Tag**: ${{ steps.forgejo.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Name**: ${{ steps.forgejo.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release Tag**: ${{ steps.forgejo.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Exists**: ${{ steps.check.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Needs Update**: ${{ steps.check.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.needs_update }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Assets Mirrored" >> $GITHUB_STEP_SUMMARY
            if [ -d "assets" ]; then
              asset_count=$(ls -1 assets/ 2>/dev/null | wc -l)
              echo "- **Total Assets**: $asset_count" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Asset Details:" >> $GITHUB_STEP_SUMMARY
              for file in assets/*; do
                if [ -f "$file" ]; then
                  file_size=$(stat -c%s "$file" 2>/dev/null || echo "unknown")
                  echo "- $(basename "$file") ($file_size bytes)" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ **Status**: Success" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "failure" ]; then
            echo "‚ùå **Status**: Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload assets
        if: steps.check.outputs.needs_update == 'true'
        run: |
          gh release upload "${{ steps.forgejo.outputs.release_tag }}" assets/*
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send notification
        if: steps.check.outputs.needs_update == 'true'
        run: |
          if [ -n "${{ secrets.NOTIFY_WEBHOOK }}" ]; then
            # Check if this is an update or new release
            if [ "${{ steps.check.outputs.exists }}" = "true" ]; then
              message="üöÄ Citron release updated: **${{ steps.forgejo.outputs.release_tag }}** (new assets added)"
            else
              message="üöÄ New Citron release mirrored: **${{ steps.forgejo.outputs.release_tag }}** (draft created)"
            fi
            
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"content\":\"$message\"}" \
              "${{ secrets.NOTIFY_WEBHOOK }}" || echo "‚ö†Ô∏è  Webhook notification failed (webhook may not be configured)"
          else
            echo "‚ö†Ô∏è  Webhook not configured, skipping notification"
          fi

      # Send failure notification if workflow fails
      - name: Notify on failure
        if: failure()
        run: |
          echo "Sending failure notification..."
          if [ -n "${{ secrets.NOTIFY_WEBHOOK }}" ]; then
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "{\"content\":\"‚ùå Citron mirror workflow failed for tag: **${{ steps.forgejo.outputs.tag }}**\\n\\n**Reason**: Workflow execution failed\\n\\n**GitHub Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
              "${{ secrets.NOTIFY_WEBHOOK }}" || echo "‚ö†Ô∏è  Failed to send failure notification (webhook may not be configured)"
          else
            echo "‚ö†Ô∏è  Webhook not configured, skipping failure notification"
          fi
